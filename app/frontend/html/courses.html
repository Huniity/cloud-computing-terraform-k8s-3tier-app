<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - Learning Hub</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">Learning Hub</div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/courses.html" class="nav-link active">Courses</a></li>
                <li><a href="/login.html" class="nav-link" id="loginLink">Login</a></li>
                <li><a href="/signup.html" class="nav-link" id="signupLink">Sign Up</a></li>
                <li style="display: none;" id="userMenu">
                    <a href="/my-enrollments.html" class="nav-link">My Enrollments</a>
                </li>
                <li style="display: none;" id="mentorMenu">
                    <a href="/mentor-dashboard.html" class="nav-link">My Courses</a>
                </li>
                <li style="display: none;" id="logoutMenu">
                    <button onclick="logout()" class="nav-link logout-btn">Logout</button>
                </li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <section class="courses-section">
            <div class="courses-header">
                <h2>Available Courses</h2>
                <div class="filter-section">
                    <label for="categoryFilter">Filter by Category:</label>
                    <select id="categoryFilter" onchange="filterCourses()">
                        <option value="">All Categories</option>
                    </select>
                    <div id="createCourseBtn" style="display: none;">
                        <a href="/create-course.html" class="btn btn-primary">Create Course</a>
                    </div>
                </div>
            </div>

            <div id="coursesList" class="courses-grid">
                <div class="loading">Loading courses...</div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2026 Learning Hub. All rights reserved.</p>
    </footer>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        async function loadCourses() {
            try {
                const courses = await apiCall('/courses/');
                
                const coursesList = document.getElementById('coursesList');
                coursesList.innerHTML = '';
                
                if (courses.length === 0) {
                    coursesList.innerHTML = '<p>No courses available</p>';
                    return;
                }
                
                courses.forEach(course => {
                    const courseCard = createCourseCard(course);
                    coursesList.appendChild(courseCard);
                });
            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('coursesList').innerHTML = '<p>Error loading courses</p>';
            }
        }

        function createCourseCard(course) {
            const card = document.createElement('div');
            card.className = 'course-card';
            
            const isEnrolled = course.is_enrolled;
            const enrollBtnText = isEnrolled ? 'Enrolled' : 'Enroll';
            const enrollBtnClass = isEnrolled ? 'btn-success' : 'btn-primary';
            const enrollBtnDisabled = isEnrolled ? 'disabled' : '';
            const enrollBtnOnclick = isEnrolled ? '' : `onclick="toggleEnrollment(${course.id}, event.target)"`;
            
            card.innerHTML = `
                <h3>${course.course_title}</h3>
                <p class="category">${course.category}</p>
                <p class="instructor">by ${course.user_username}</p>
                <p class="description">${course.description}</p>
                <p class="price">$${course.price}</p>
                <p class="students">${course.student_count} students enrolled</p>
                <button class="btn ${enrollBtnClass}" ${enrollBtnOnclick} ${enrollBtnDisabled}>${enrollBtnText}</button>
            `;
            
            return card;
        }

        async function filterCourses() {
            const category = document.getElementById('categoryFilter').value;
            try {
                const url = category ? `/courses/?category=${category}` : '/courses/';
                const courses = await apiCall(url);
                
                const coursesList = document.getElementById('coursesList');
                coursesList.innerHTML = '';
                
                courses.forEach(course => {
                    const courseCard = createCourseCard(course);
                    coursesList.appendChild(courseCard);
                });
            } catch (error) {
                console.error('Error filtering courses:', error);
            }
        }

        async function toggleEnrollment(courseId, button) {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            try {
                // Update button IMMEDIATELY for instant feedback
                button.textContent = 'Enrolled';
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                button.disabled = true;
                
                await apiCall(`/courses/${courseId}/enroll/`, 'POST');
                // Don't reload - keep the button in enrolled state
            } catch (error) {
                console.error('Error enrolling:', error);
                // Revert button if enrollment fails
                button.textContent = 'Enroll';
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
                button.disabled = false;
                alert('Error: ' + error.message);
            }
        }

        async function loadCategories() {
            try {
                const data = await apiCall('/courses/categories/');
                const select = document.getElementById('categoryFilter');
                
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadCourses();
            loadCategories();
        });
    </script>
</body>
</html>
